<div class="orders-container">

  <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-3 mb-3">
    <div>
      <h2 class="fw-bold mb-1">Gestión de pedidos</h2>
      <p class="text-muted mb-0">Registro, seguimiento, edición y cancelación.</p>
    </div>

    <span class="badge bg-light text-dark border">Rol: Admin / Gerencia / Empleado (UI)</span>
  </div>

  <!-- FORMULARIO: REGISTRAR PEDIDO -->
  <div class="card p-4 shadow-sm mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
      <h5 class="mb-0">Registrar nuevo pedido</h5>
      <span class="badge bg-secondary">Estado inicial: {{ newOrder.status }}</span>
    </div>

    <p class="text-muted mb-3">Complete cliente, tipo de producto, cantidad y fecha de entrega.</p>

    @if (errorMsg) {
      <div class="alert alert-danger">{{ errorMsg }}</div>
    }
    @if (successMsg) {
      <div class="alert alert-success">{{ successMsg }}</div>
    }

    <div class="row g-3">
      <div class="col-12 col-lg-4">
        <label class="form-label fw-semibold">Cliente <span class="text-danger">*</span></label>
        <input class="form-control" [(ngModel)]="newOrder.customer" placeholder="Ej: APF Liceo Samuel Sáenz">
      </div>

      <div class="col-12 col-md-6 col-lg-3">
        <label class="form-label fw-semibold">Tipo de producto</label>
        <select class="form-select" [(ngModel)]="newOrder.productType">
          @for (p of productTypes; track p) {
            <option [value]="p">{{ p }}</option>
          }
        </select>
      </div>

      <div class="col-12 col-md-6 col-lg-2">
        <label class="form-label fw-semibold">Cantidad <span class="text-danger">*</span></label>
        <input type="number" min="1" class="form-control" [(ngModel)]="newOrder.quantity" placeholder="0">
      </div>

      <div class="col-12 col-lg-3">
        <label class="form-label fw-semibold">Fecha de entrega <span class="text-danger">*</span></label>
        <input type="date" class="form-control" [(ngModel)]="newOrder.deliveryDate">
      </div>
    </div>

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 mt-3">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="notify" [(ngModel)]="newOrder.notifyClient">
        <label class="form-check-label" for="notify">
          Notificación opcional al cliente (simulada)
        </label>
      </div>

      <button class="btn btn-primary" (click)="simulateCreate()">
        Registrar pedido
      </button>
    </div>

    <small class="text-muted d-block mt-2">
    </small>
  </div>

  <div class="row g-3">
    <!-- LISTADO + FILTROS -->
    <div class="col-12 col-xl-8">
      <div class="card p-4 shadow-sm h-100">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
          <h5 class="mb-0">Listado de pedidos</h5>
          <span class="badge bg-primary">Gerencia</span>
        </div>

        <!-- filtros -->
        <div class="row g-3 mb-3">
          <div class="col-12 col-md-5">
            <label class="form-label fw-semibold">Buscar</label>
            <input class="form-control" [(ngModel)]="filter.search" placeholder="Cliente, código, producto...">
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label fw-semibold">Filtrar por estado</label>
            <select class="form-select" [(ngModel)]="filter.status">
              @for (s of statusOptions; track s) {
                <option [value]="s">{{ s }}</option>
              }
            </select>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">Ordenar</label>
            <div class="d-flex gap-2">
              <select class="form-select" [(ngModel)]="filter.sortBy">
                @for (o of sortOptions; track o) {
                  <option [value]="o">{{ o }}</option>
                }
              </select>
              <select class="form-select" style="max-width: 110px;" [(ngModel)]="filter.sortDir">
                <option value="Asc">Asc</option>
                <option value="Desc">Desc</option>
              </select>
            </div>
          </div>
        </div>

        <!-- tabla -->
        <div class="table-responsive">
          <table class="table align-middle">
            <thead class="text-muted">
              <tr>
                <th>Código</th>
                <th>Cliente</th>
                <th class="d-none d-lg-table-cell">Producto</th>
                <th class="text-end d-none d-md-table-cell">Cantidad</th>
                <th class="text-end">Entrega</th>
                <th class="text-end">Estado</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>

            <tbody>
              @for (o of orders; track o.id) {
                <tr>
                  <td class="fw-semibold">{{ o.id }}</td>
                  <td>{{ o.customer }}</td>
                  <td class="d-none d-lg-table-cell">{{ o.productType }}</td>
                  <td class="text-end d-none d-md-table-cell">{{ o.quantity }}</td>
                  <td class="text-end">{{ o.deliveryDate }}</td>
                  <td class="text-end">
                    <span class="badge"
                          [ngClass]="statusBadgeClass(o.status)">
                      {{ o.status }}
                    </span>
                  </td>

                  <td class="text-end">
                    <div class="btn-group">
                      <button class="btn btn-outline-secondary btn-sm" (click)="openEdit(o)">
                        Editar
                      </button>
                      <button class="btn btn-outline-danger btn-sm" (click)="openCancel(o)">
                        Cancelar
                      </button>
                    </div>
                  </td>
                </tr>

                <!-- Cambiar estado (empleado) -->
                <tr class="sub-row">
                  <td colspan="7">
                    <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-2">
                      <div class="text-muted small">
                        <span class="fw-semibold">Actualizar estado:</span>
                        (cambio válido / historial / notificación: )
                      </div>

                      <div class="d-flex flex-wrap gap-2 justify-content-end">
                        <button class="btn btn-outline-primary btn-sm" (click)="simulateStatusChange(o, 'En producción')">
                          En producción
                        </button>
                        <button class="btn btn-outline-info btn-sm" (click)="simulateStatusChange(o, 'Listo')">
                          Listo
                        </button>
                        <button class="btn btn-outline-success btn-sm" (click)="simulateStatusChange(o, 'Entregado')">
                          Entregado
                        </button>
                        <button class="btn btn-outline-warning btn-sm" (click)="simulateStatusChange(o, 'Atrasado')">
                          Atrasado
                        </button>
                      </div>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <small class="text-muted d-block mt-2">
          * Filtros y ordenamiento son visuales (no aplican a la data mock).
        </small>
      </div>
    </div>

    <!-- HISTORIAL / AUDITORÍA -->
    <div class="col-12 col-xl-4">
      <div class="card p-4 shadow-sm h-100">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="mb-0">Historial / Auditoría</h5>
          <span class="badge bg-dark">Admin</span>
        </div>

        <p class="text-muted small mb-3">
          Registro de cambios de estado, modificaciones y cancelaciones (mock).
        </p>

        <div class="history-list">
          @for (h of history; track h.date + h.orderId) {
            <div class="history-item">
              <div class="d-flex justify-content-between">
                <div class="fw-semibold">{{ h.action }}</div>
                <small class="text-muted">{{ h.date }}</small>
              </div>
              <div class="text-muted small">
                <span class="badge bg-light text-dark border me-1">{{ h.orderId }}</span>
                {{ h.detail }}
              </div>
            </div>
          }
        </div>

        <div class="mt-3">
          <button class="btn btn-outline-secondary w-100 btn-sm">Exportar historial</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PANEL EDITAR (simula modal) -->
  @if (editPanelOpen && selectedOrder) {
    <div class="overlay">
      <div class="panel card shadow-lg">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <h5 class="mb-0">Editar pedido</h5>
            <small class="text-muted">Actualizar información general + validación</small>
          </div>
          <button class="btn btn-sm btn-outline-secondary" (click)="closePanels()">Cerrar</button>
        </div>

        <div class="row g-3">
          <div class="col-12">
            <label class="form-label fw-semibold">Cliente</label>
            <input class="form-control" [(ngModel)]="editModel.customer">
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">Tipo de producto</label>
            <select class="form-select" [(ngModel)]="editModel.productType">
              @for (p of productTypes; track p) {
                <option [value]="p">{{ p }}</option>
              }
            </select>
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label fw-semibold">Cantidad</label>
            <input type="number" class="form-control" [(ngModel)]="editModel.quantity">
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label fw-semibold">Entrega</label>
            <input type="date" class="form-control" [(ngModel)]="editModel.deliveryDate">
          </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-3">
          <button class="btn btn-outline-secondary" (click)="closePanels()">Cancelar</button>
          <button class="btn btn-primary" (click)="simulateSaveEdit()">Guardar cambios</button>
        </div>

        <small class="text-muted d-block mt-2">
          Auditoría: simulada (se mostraría en historial).
        </small>
      </div>
    </div>
  }

  <!-- PANEL CANCELAR (simula modal) -->
  @if (cancelPanelOpen && selectedOrder) {
    <div class="overlay">
      <div class="panel card shadow-lg">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <h5 class="mb-0">Cancelar pedido (lógico)</h5>
            <small class="text-muted">No elimina datos, conserva historial</small>
          </div>
          <button class="btn btn-sm btn-outline-secondary" (click)="closePanels()">Cerrar</button>
        </div>

        <div class="alert alert-warning">
          Estás por cancelar <span class="fw-semibold">{{ selectedOrder.id }}</span>. Esta acción requiere confirmación.
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Motivo (opcional)</label>
          <textarea class="form-control" rows="2" [(ngModel)]="cancelReason"
            placeholder="Ej: Cliente solicitó cancelación / error en cantidad..."></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Escribe <code>CANCELAR</code> para confirmar</label>
          <input class="form-control" [(ngModel)]="requireConfirmText" placeholder="CANCELAR">
        </div>

        @if (errorMsg) {
          <div class="alert alert-danger">{{ errorMsg }}</div>
        }

        <div class="d-flex justify-content-end gap-2">
          <button class="btn btn-outline-secondary" (click)="closePanels()">Volver</button>
          <button class="btn btn-danger" (click)="simulateCancel()">Confirmar cancelación</button>
        </div>

        <small class="text-muted d-block mt-2">
          Persistencia en historial: simulada.
        </small>
      </div>
    </div>
  }

</div>
