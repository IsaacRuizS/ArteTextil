<div class="products-wrapper p-3 p-md-4">

    <!-- HEADER -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
        <div>
            <h2 class="fw-bold mb-1">Catálogo de Productos</h2>
            <div class="text-muted small">Administra tu inventario, precios y estado del catálogo.</div>
        </div>

        <button class="btn btn-primary" (click)="openCreateModal()">
            <i class="mdi mdi-cube-send me-1"></i>Nuevo Producto
        </button>
    </div>

    <!-- FILTER -->
    <div class="mb-4">
        <div class="input-group">
            <span class="input-group-text bg-white">
                <i class="mdi mdi-magnify"></i>
            </span>
            <input type="text" class="form-control" placeholder="Buscar por nombre o código..."
                (input)="onSearch($event)">
        </div>
    </div>

    <!-- LIST -->
    <div class="card shadow-sm border-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-3 ps-md-4">Código</th>
                        <th>Producto</th>

                        <!-- Ocultar en móvil para no apretar -->
                        <th class="d-none d-lg-table-cell">Descripción</th>

                        <th>Precio</th>
                        <th>Stock</th>
                        <th>Estado</th>
                        <th class="text-end pe-3 pe-md-4">Acciones</th>
                    </tr>
                </thead>

                <tbody>
                    @if (filteredProducts.length === 0) {
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            No hay productos registrados.
                        </td>
                    </tr>
                    } @else {
                    @for (p of filteredProducts; track p.productId) {
                    <tr>
                        <td class="ps-3 ps-md-4 fw-bold text-muted">{{ p.productCode }}</td>

                        <td class="fw-semibold">
                            <div class="d-flex flex-column">
                                <span>{{ p.name }}</span>
                                <span class="text-muted small">
                                    {{ getCategoryName(p.categoryId) }}
                                </span>
                            </div>
                        </td>

                        <td class="d-none d-lg-table-cell text-muted small text-truncate" style="max-width: 280px;">
                            {{ p.description || '-' }}
                        </td>

                        <td>₡{{ p.price }}</td>

                        <td>
                            <span class="badge" [class.bg-warning-subtle]="p.stock < (p.minStock)"
                                [class.text-warning-emphasis]="p.stock < (p.minStock)"
                                [class.bg-success-subtle]="p.stock >= (p.minStock)"
                                [class.text-success-emphasis]="p.stock >= (p.minStock)">
                                {{ p.stock }} un.
                            </span>

                            <div class="text-muted small d-none d-md-block">
                                Mín: {{ p.minStock }}
                            </div>
                        </td>

                        <td>
                            <span class="badge rounded-pill" [class.bg-success-subtle]="p.isActive"
                                [class.text-success]="p.isActive" [class.bg-secondary-subtle]="!p.isActive"
                                [class.text-secondary]="!p.isActive">
                                {{ p.isActive ? 'Activo' : 'Inactivo' }}
                            </span>
                        </td>

                        <td class="text-end pe-3 pe-md-4">
                            <button class="btn btn-sm btn-light text-primary me-2" (click)="openEditModal(p)">
                                <i class="mdi mdi-pencil"></i>
                            </button>

                            <button class="btn btn-sm btn-light text-danger" (click)="openDeleteModal(p)">
                                <i class="mdi mdi-delete"></i>
                            </button>
                        </td>
                    </tr>
                    }
                    }
                </tbody>

            </table>
        </div>
    </div>

</div>

<!-- FORM MODAL -->
@if (showFormModal) {
<div class="modal d-block" tabindex="-1" style="background: rgba(0,0,0,0.5)">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">

            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">{{ isEditing ? 'Editar' : 'Nuevo' }} Producto</h5>
                <button type="button" class="btn-close" (click)="closeFormModal()"></button>
            </div>

            <div class="modal-body">
                <form [formGroup]="productForm">

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label small fw-bold text-muted">Código</label>
                            <input type="text" class="form-control" formControlName="productCode"
                                [class.is-invalid]="productForm.get('productCode')?.invalid && productForm.get('productCode')?.touched">
                            @if(productForm.get('productCode')?.invalid && productForm.get('productCode')?.touched) {
                            <div class="invalid-feedback d-block">Código requerido.</div>
                            }
                        </div>

                        <div class="col-md-8 mb-3">
                            <label class="form-label small fw-bold text-muted">Nombre del Producto</label>
                            <input type="text" class="form-control" formControlName="name"
                                [class.is-invalid]="productForm.get('name')?.invalid && productForm.get('name')?.touched">
                            @if(productForm.get('name')?.invalid && productForm.get('name')?.touched) {
                            <div class="invalid-feedback d-block">Nombre requerido (mín 3).</div>
                            }
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Descripción</label>
                        <textarea class="form-control" rows="2" formControlName="description"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label small fw-bold text-muted">Precio (₡)</label>
                            <input type="number" class="form-control" formControlName="price"
                                [class.is-invalid]="productForm.get('price')?.invalid && productForm.get('price')?.touched">
                            @if(productForm.get('price')?.invalid && productForm.get('price')?.touched) {
                            <div class="invalid-feedback d-block">Precio debe ser mayor a 0.</div>
                            }
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label small fw-bold text-muted">Stock</label>
                            <input type="number" class="form-control" formControlName="stock"
                                [class.is-invalid]="productForm.get('stock')?.invalid && productForm.get('stock')?.touched">
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label small fw-bold text-muted">Stock mínimo</label>
                            <input type="number" class="form-control" formControlName="minStock"
                                [class.is-invalid]="productForm.get('minStock')?.invalid && productForm.get('minStock')?.touched">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label small fw-bold text-muted">Categoría</label>
                            <select class="form-select" formControlName="categoryId"
                                [class.is-invalid]="productForm.get('categoryId')?.invalid && productForm.get('categoryId')?.touched">
                                @if(categories.length === 0) {
                                <option [ngValue]="null">Cargando categorías...</option>
                                } @else {
                                @for (c of categories; track c.categoryId) {
                                <option [ngValue]="c.categoryId" [disabled]="!c.isActive">
                                    {{ c.name }} @if(!c.isActive){ (Inactiva) }
                                </option>
                                }
                                }
                            </select>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label small fw-bold text-muted">Activo</label>
                            <select class="form-select" formControlName="isActive">
                                <option [ngValue]="true">Sí</option>
                                <option [ngValue]="false">No</option>
                            </select>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label small fw-bold text-muted">Proveedor</label>

                            <select class="form-select" formControlName="supplierId"
                                [class.is-invalid]="productForm.get('supplierId')?.invalid && productForm.get('supplierId')?.touched">

                                @if(suppliers.length === 0) {
                                <option [ngValue]="null">Cargando proveedores...</option>
                                } @else {
                                @for (s of suppliers; track s.supplierId) {
                                <option [ngValue]="s.supplierId">
                                    {{ s.name }}
                                </option>
                                }
                                }

                            </select>
                        </div>

                    </div>

                </form>
            </div>

            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light" (click)="closeFormModal()">Cancelar</button>
                <button type="button" class="btn btn-primary px-4" (click)="saveProduct()">
                    Guardar Producto
                </button>
            </div>

        </div>
    </div>
</div>
}

<!-- DELETE MODAL -->
@if (showDeleteModal) {
<div class="modal d-block" tabindex="-1" style="background: rgba(0,0,0,0.5)">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content text-center p-3">
            <div class="modal-body">
                <div class="mb-3 text-warning display-4">
                    <i class="mdi mdi-package-variant-closed-remove"></i>
                </div>

                <h5 class="mb-2 fw-bold">¿Desactivar Producto?</h5>
                <p class="text-muted small mb-0">
                    El producto no aparecerá disponible para ventas ni movimientos.
                </p>

                <div class="d-flex justify-content-center gap-2 mt-4">
                    <button class="btn btn-light" (click)="showDeleteModal = false">Cancelar</button>
                    <button class="btn btn-danger px-4" (click)="confirmDelete()">Sí, desactivar</button>
                </div>
            </div>
        </div>
    </div>
</div>
}