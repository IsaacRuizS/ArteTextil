<div class="users-wrapper">

    <div class="d-flex justify-content-between mb-4">
        <h2 class="fw-bold">Gestión de Usuarios</h2>
        <button class="btn btn-primary" (click)="openCreateModal()">
            <i class="mdi mdi-account-plus me-1"></i> Nuevo Usuario
        </button>
    </div>

    <!-- FILTRO -->
    <div class="filter-box card p-3 shadow-sm mb-4">
        <div class="row align-items-center">
            <div class="col-md-4">
                <label class="form-label fw-semibold">Filtrar por Rol</label>
                <select class="form-select" [(ngModel)]="selectedRoleFilter">
                    <option value="Todos">Todos</option>
                    @for (r of roles; track r.roleId) {
                    <option [value]="r.roleId">{{ r.name }}</option>
                    }
                </select>
            </div>
        </div>
    </div>

    <!-- LISTADO -->
    <div class="table-responsive card shadow-sm p-3">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Rol</th>
                    <th>Teléfono</th>
                    <th>Estado</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @for (user of filteredUsers; track user.userId) {
                <tr>
                    <td>
                        <div class="fw-bold">{{ user.fullName }}</div>
                    </td>
                    <td>{{ user.email }}</td>
                    <td>
                        <span class="badge bg-info text-dark">{{ getRoleName(user.roleId) }}</span>
                    </td>
                    <td>{{ user.phone || 'N/A' }}</td>
                    <td>
                        <span class="badge" [class.bg-success]="user.isActive" [class.bg-secondary]="!user.isActive">
                            {{ user.isActive ? 'Activo' : 'Inactivo' }}
                        </span>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-2" (click)="openEditModal(user)">
                            <i class="mdi mdi-pencil"></i>
                        </button>

                        @if(user.isActive){
                        <button class="btn btn-sm btn-outline-danger" (click)="openDeleteConfirmation(user)">
                            <i class="mdi mdi-account-off"></i>
                        </button>
                        } @else {
                        <button class="btn btn-sm btn-outline-secondary" disabled>
                            <i class="mdi mdi-lock"></i>
                        </button>
                        }
                    </td>
                </tr>
                }
                @if (filteredUsers.length === 0) {
                <tr>
                    <td colspan="6" class="text-center py-4 text-muted">
                        No se encontraron usuarios.
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </div>

</div>

<!-- ========================= -->
<!-- MODAL FORMULARIO (CREAR/EDITAR) -->
<!-- ========================= -->
@if (showFormModal) {
<div class="modal d-block" tabindex="-1" role="dialog">
    <div class="modal-backdrop fade show"></div>
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">
                    {{ isEditing ? 'Editar Usuario' : 'Nuevo Usuario' }}
                </h5>
                <button type="button" class="btn-close" (click)="closeFormModal()"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label class="form-label">Nombre Completo <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" [(ngModel)]="currentUser.fullName" name="fullName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Correo Electrónico <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" [(ngModel)]="currentUser.email" name="email">
                    </div>

                    @if (!isEditing) {
                    <div class="mb-3">
                        <label class="form-label">Contraseña <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" [(ngModel)]="currentUser.password" name="password">
                    </div>
                    }

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Rol</label>
                            <select class="form-select" [(ngModel)]="currentUser.roleId" name="roleId">
                                @for (r of roles; track r.roleId) {
                                <option [value]="r.roleId">{{ r.name }}</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Teléfono</label>
                            <input type="text" class="form-control" [(ngModel)]="currentUser.phone" name="phone">
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeFormModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" (click)="saveUser()">Guardar</button>
            </div>
        </div>
    </div>
</div>
}

<!-- ========================= -->
<!-- MODAL CONFIRMACION DELETE -->
<!-- ========================= -->
@if (showDeleteModal) {
<div class="modal d-block" tabindex="-1" role="dialog">
    <div class="modal-backdrop fade show"></div>
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Desactivar Usuario</h5>
                <button type="button" class="btn-close btn-close-white" (click)="closeDeleteModal()"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro que desea desactivar al usuario <strong>{{ userToDelete?.fullName }}</strong>?</p>
                <p class="small text-muted mb-0">Esta acción impedirá que el usuario inicie sesión.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">Cancelar</button>
                <button type="button" class="btn btn-danger" (click)="confirmDelete()">Desactivar</button>
            </div>
        </div>
    </div>
</div>
}