<div class="users-wrapper">

    <div class="d-flex justify-content-between mb-4">
        <h2 class="fw-bold">Gestión de Usuarios</h2>
        <button class="btn btn-primary" (click)="openCreateModal()">
            <i class="mdi mdi-account-plus me-1"></i> Nuevo Usuario
        </button>
    </div>

    <!-- FILTER -->
    <div class="mb-4">
        <input type="text" class="form-control" placeholder="Buscar por nombre o contacto..."
            (input)="onSearch($event)">
    </div>

    <!-- LISTADO -->
    <div class="table-responsive card shadow-sm p-3">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Rol</th>
                    <th>Teléfono</th>
                    <th>Estado</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let user of users;">
                    <td>
                        <div class="fw-bold">{{ user.fullName }}</div>
                    </td>
                    <td>{{ user.email }}</td>
                    <td>
                        <span class="badge bg-info text-dark">{{ getRoleName(user.roleId) }}</span>
                    </td>
                    <td>{{ user.phone || 'N/A' }}</td>
                    <td>
                        <span class="badge" [class.bg-success]="user.isActive" [class.bg-secondary]="!user.isActive">
                            {{ user.isActive ? 'Activo' : 'Inactivo' }}
                        </span>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-2" (click)="openEditModal(user)">
                            <i class="mdi mdi-pencil"></i>
                        </button>

                        @if(user.isActive){
                        <button class="btn btn-sm btn-outline-danger" (click)="openDeleteModal(user)">
                            <i class="mdi mdi-account-off"></i>
                        </button>
                        } @else {
                        <button class="btn btn-sm btn-outline-secondary" disabled>
                            <i class="mdi mdi-lock"></i>
                        </button>
                        }
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

</div>

<!-- FORM MODAL USUARIOS -->
@if (showFormModal) {
<div class="modal d-block" tabindex="-1" style="background: rgba(0,0,0,0.5)">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <!-- HEADER -->
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">
                    {{ isEditing ? 'Editar Usuario' : 'Nuevo Usuario' }}
                </h5>
                <button type="button" class="btn-close" (click)="showFormModal = false"></button>
            </div>

            <!-- BODY -->
            <div class="modal-body">
                <form [formGroup]="userForm">

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">
                            Nombre Completo
                        </label>
                        <input
                            type="text"
                            class="form-control"
                            formControlName="fullName"
                            [class.is-invalid]="userForm.get('fullName')?.invalid && userForm.get('fullName')?.touched">
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">
                            Correo Electrónico
                        </label>
                        <input
                            type="email"
                            class="form-control"
                            formControlName="email"
                            [class.is-invalid]="userForm.get('email')?.invalid && userForm.get('email')?.touched">
                    </div>

                    @if (!isEditing) {
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">
                            Contraseña
                        </label>
                        <input
                            type="password"
                            class="form-control"
                            formControlName="password"
                            [class.is-invalid]="userForm.get('password')?.invalid && userForm.get('password')?.touched">
                    </div>
                    }

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label small fw-bold text-muted">Rol</label>
                            <select
                                class="form-select"
                                formControlName="roleId"
                                [class.is-invalid]="userForm.get('roleId')?.invalid && userForm.get('roleId')?.touched">
                                <option value="">Seleccione un rol</option>
                                @for (r of roles; track r.roleId) {
                                <option [value]="r.roleId">{{ r.name }}</option>
                                }
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label small fw-bold text-muted">Teléfono</label>
                            <input
                                type="text"
                                class="form-control"
                                formControlName="phone">
                        </div>
                    </div>

                </form>
            </div>

            <!-- FOOTER -->
            <div class="modal-footer border-0 pt-0">
                <button
                    type="button"
                    class="btn btn-light"
                    (click)="showFormModal = false">
                    Cancelar
                </button>
                <button
                    type="button"
                    class="btn btn-primary px-4"
                    [disabled]="userForm.invalid"
                    (click)="saveUser()">
                    Guardar
                </button>
            </div>

        </div>
    </div>
</div>
}

<!-- DELETE MODAL USUARIO -->
@if (showDeleteModal) {
<div class="modal d-block" tabindex="-1" style="background: rgba(0,0,0,0.5)">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content text-center p-3">

            <div class="modal-body">
                <div class="mb-3 text-danger display-4">
                    <i class="mdi mdi-alert-circle-outline"></i>
                </div>

                <h5 class="mb-2 fw-bold">¿Desactivar usuario?</h5>

                <p class="text-muted small">
                    El usuario <strong>{{ userToDelete?.fullName }}</strong> no podrá iniciar sesión.
                </p>

                <div class="d-flex justify-content-center gap-2 mt-4">
                    <button
                        type="button"
                        class="btn btn-light"
                        (click)="showDeleteModal = false">
                        Cancelar
                    </button>

                    <button
                        type="button"
                        class="btn btn-danger px-4"
                        (click)="confirmDelete()">
                        Sí, desactivar
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>
}
