<div class="reports-container">

  <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-3 mb-3">
    <div>
      <h2 class="fw-bold mb-1">Reportes</h2>
      <p class="text-muted mb-0">Generación y visualización de reportes.</p>
    </div>

    <div class="export-box shadow-sm">
      <div class="d-flex align-items-center justify-content-between gap-3">
        <div>
          <div class="fw-semibold">Exportar / Descargar</div>
          <small class="text-muted">Simulado</small>
        </div>

        <div class="d-flex align-items-center gap-2">
          <select class="form-select form-select-sm" style="min-width: 120px;" [(ngModel)]="selectedExport">
            @for (f of exportFormats; track f) {
              <option [value]="f">{{ f }}</option>
            }
          </select>
          <button class="btn btn-primary btn-sm">
            Descargar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- SELECTOR DE REPORTE -->
  <div class="card p-4 shadow-sm mb-4">
    <div class="row g-3 align-items-end">
      <div class="col-12 col-lg-5">
        <label class="form-label fw-semibold">Tipo de reporte</label>
        <select class="form-select" [(ngModel)]="selectedReport">
          <optgroup label="Ventas (Admin)">
            <option>Ventas por producto</option>
            <option>Ventas por cliente</option>
            <option>Ventas por período</option>
          </optgroup>

          <optgroup label="Productividad (Gerencia)">
            <option>Productividad por empleado</option>
            <option>Productividad por etapa</option>
          </optgroup>

          <optgroup label="Inventario (Admin)">
            <option>Inventario: rotación</option>
            <option>Inventario: consumo</option>
            <option>Inventario: niveles de stock</option>
          </optgroup>

          <optgroup label="Comparativos (Gerencia)">
            <option>Comparativo mensual: ventas</option>
            <option>Comparativo mensual: producción</option>
          </optgroup>
        </select>
      </div>

      <!-- FILTROS (según el tipo) -->
      <div class="col-12 col-md-6 col-lg-2">
        <label class="form-label fw-semibold">Desde</label>
        <input type="date" class="form-control" [(ngModel)]="filters.from">
      </div>

      <div class="col-12 col-md-6 col-lg-2">
        <label class="form-label fw-semibold">Hasta</label>
        <input type="date" class="form-control" [(ngModel)]="filters.to">
      </div>

      <div class="col-12 col-md-6 col-lg-3">
        <label class="form-label fw-semibold">Período</label>
        <select class="form-select" [(ngModel)]="filters.period">
          @for (p of periodOptions; track p) {
            <option [value]="p">{{ p }}</option>
          }
        </select>
      </div>
    </div>

    <div class="row g-3 mt-1">
      @if (isSalesReport()) {
        <div class="col-12 col-md-6 col-lg-4">
          <label class="form-label fw-semibold">Producto (opcional)</label>
          <input class="form-control" placeholder="Ej: Camisa blanca" [(ngModel)]="filters.product">
        </div>
        <div class="col-12 col-md-6 col-lg-4">
          <label class="form-label fw-semibold">Cliente (opcional)</label>
          <input class="form-control" placeholder="Ej: APF / Cliente Mostrador" [(ngModel)]="filters.client">
        </div>
      }

      @if (isProductivityReport()) {
        <div class="col-12 col-md-6 col-lg-4">
          <label class="form-label fw-semibold">Empleado</label>
          <select class="form-select" [(ngModel)]="filters.employee">
            @for (e of employees; track e) {
              <option [value]="e">{{ e }}</option>
            }
          </select>
        </div>
        <div class="col-12 col-md-6 col-lg-4">
          <label class="form-label fw-semibold">Etapa</label>
          <select class="form-select" [(ngModel)]="filters.stage">
            @for (s of stages; track s) {
              <option [value]="s">{{ s }}</option>
            }
          </select>
        </div>
      }

      @if (isInventoryReport()) {
        <div class="col-12 col-md-6 col-lg-4">
          <label class="form-label fw-semibold">Materia prima / Insumo</label>
          <input class="form-control" placeholder="Ej: Tela blanca, botones..." />
        </div>
      }

      <div class="col-12 col-lg-4 ms-auto d-flex justify-content-lg-end">
        <button class="btn btn-outline-secondary w-100 w-lg-auto">
          Generar reporte
        </button>
      </div>
    </div>

    <div class="mt-3 d-flex flex-wrap gap-2">
      <span class="badge bg-light text-dark border">Reporte: {{ selectedReport }}</span>
      <span class="badge bg-light text-dark border">Rango: {{ filters.from || '—' }} → {{ filters.to || '—' }}</span>
      <span class="badge bg-light text-dark border">Período: {{ filters.period }}</span>
    </div>
  </div>

  <!-- RESULTADOS -->
  <div class="card p-4 shadow-sm">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
      <h5 class="mb-0">Resultados</h5>
      <span class="badge bg-success">Vista prototipo</span>
    </div>

    <!-- Ventas por producto -->
    @if (selectedReport === 'Ventas por producto') {
      <p class="text-muted">Reporte de ventas agrupado por producto.</p>
      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="text-muted">
            <tr>
              <th>Producto</th>
              <th class="text-end">Unidades</th>
              <th class="text-end">Ingresos</th>
            </tr>
          </thead>
          <tbody>
            @for (r of salesByProduct; track r.product) {
              <tr>
                <td class="fw-semibold">{{ r.product }}</td>
                <td class="text-end">{{ r.units }}</td>
                <td class="text-end">{{ r.revenue }}</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    <!-- Ventas por cliente -->
    @if (selectedReport === 'Ventas por cliente') {
      <p class="text-muted">Reporte de ventas agrupado por cliente.</p>
      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="text-muted">
            <tr>
              <th>Cliente</th>
              <th class="text-end">Pedidos</th>
              <th class="text-end">Ingresos</th>
            </tr>
          </thead>
          <tbody>
            @for (r of salesByClient; track r.client) {
              <tr>
                <td class="fw-semibold">{{ r.client }}</td>
                <td class="text-end">{{ r.orders }}</td>
                <td class="text-end">{{ r.revenue }}</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    <!-- Ventas por período -->
    @if (selectedReport === 'Ventas por período') {
      <p class="text-muted">Resumen de ventas según el período seleccionado.</p>

      <div class="row g-3">
        <div class="col-12 col-md-6 col-xl-4">
          <div class="mini-card p-3">
            <div class="text-muted small">Total ventas</div>
            <div class="fw-bold fs-4">₡ 1,480,000</div>
            <div class="text-muted small">Período: {{ filters.period }}</div>
          </div>
        </div>
        <div class="col-12 col-md-6 col-xl-4">
          <div class="mini-card p-3">
            <div class="text-muted small">Pedidos</div>
            <div class="fw-bold fs-4">46</div>
            <div class="text-muted small">Rango seleccionado</div>
          </div>
        </div>
        <div class="col-12 col-xl-4">
          <div class="mini-card p-3">
            <div class="text-muted small">Ticket promedio</div>
            <div class="fw-bold fs-4">₡ 32,174</div>
            <div class="text-muted small">Estimado</div>
          </div>
        </div>
      </div>
    }

    <!-- Productividad por empleado -->
    @if (selectedReport === 'Productividad por empleado') {
      <p class="text-muted">Productividad por empleado (salida vs meta).</p>

      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="text-muted">
            <tr>
              <th>Empleado</th>
              <th class="text-end">Producción</th>
              <th class="text-end">Meta</th>
              <th class="text-end">Cumplimiento</th>
            </tr>
          </thead>
          <tbody>
            @for (r of productivityByEmployee; track r.employee) {
              <tr>
                <td class="fw-semibold">{{ r.employee }}</td>
                <td class="text-end">{{ r.output }}</td>
                <td class="text-end">{{ r.target }}</td>
                <td class="text-end">
                  <span class="badge bg-light text-dark border">
                    {{ (r.output / r.target * 100) | number:'1.0-0' }}%
                  </span>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    <!-- Productividad por etapa -->
    @if (selectedReport === 'Productividad por etapa') {
      <p class="text-muted">Productividad por etapa de producción.</p>

      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="text-muted">
            <tr>
              <th>Etapa</th>
              <th class="text-end">Producción</th>
              <th class="text-end">Meta</th>
              <th class="text-end">Cumplimiento</th>
            </tr>
          </thead>
          <tbody>
            @for (r of productivityByStage; track r.stage) {
              <tr>
                <td class="fw-semibold">{{ r.stage }}</td>
                <td class="text-end">{{ r.output }}</td>
                <td class="text-end">{{ r.target }}</td>
                <td class="text-end">
                  <span class="badge bg-light text-dark border">
                    {{ (r.output / r.target * 100) | number:'1.0-0' }}%
                  </span>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    <!-- Inventario: rotación -->
    @if (selectedReport === 'Inventario: rotación') {
      <p class="text-muted">Rotación de inventario (mock).</p>

      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="text-muted">
            <tr>
              <th>Ítem</th>
              <th class="text-end">Rotación</th>
              <th class="text-end">Días de inventario</th>
            </tr>
          </thead>
          <tbody>
            @for (r of inventoryRotation; track r.item) {
              <tr>
                <td class="fw-semibold">{{ r.item }}</td>
                <td class="text-end">{{ r.rotation }}</td>
                <td class="text-end">{{ r.days }}</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    <!-- Inventario: consumo -->
    @if (selectedReport === 'Inventario: consumo') {
      <p class="text-muted">Consumo de materia prima (mock).</p>

      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="text-muted">
            <tr>
              <th>Insumo</th>
              <th class="text-end">Consumido</th>
              <th class="text-end">Unidad</th>
              <th class="text-end">Período</th>
            </tr>
          </thead>
          <tbody>
            @for (r of rawMaterialConsumption; track r.item) {
              <tr>
                <td class="fw-semibold">{{ r.item }}</td>
                <td class="text-end">{{ r.used }}</td>
                <td class="text-end">{{ r.unit }}</td>
                <td class="text-end">{{ r.period }}</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    <!-- Inventario: niveles de stock -->
    @if (selectedReport === 'Inventario: niveles de stock') {
      <p class="text-muted">Niveles de stock (con alertas visuales).</p>

      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="text-muted">
            <tr>
              <th>Ítem</th>
              <th class="text-end">Actual</th>
              <th class="text-end">Mínimo</th>
              <th class="text-end">Máximo</th>
              <th class="text-end">Estado</th>
            </tr>
          </thead>
          <tbody>
            @for (r of stockLevels; track r.item) {
              <tr>
                <td class="fw-semibold">{{ r.item }}</td>
                <td class="text-end">{{ r.current }}</td>
                <td class="text-end">{{ r.min }}</td>
                <td class="text-end">{{ r.max }}</td>
                <td class="text-end">
                  <span class="badge"
                        [class.bg-danger]="r.current < r.min"
                        [class.bg-success]="r.current >= r.min">
                    @if (r.current < r.min) { Bajo } @else { OK }
                  </span>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    <!-- Comparativos mensuales -->
    @if (isComparativeReport()) {
      <p class="text-muted">
        Comparativo mensual de @if (selectedReport.endsWith('ventas')) { ventas } @else { producción } (mock).
      </p>

      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="text-muted">
            <tr>
              <th>Mes</th>
              <th class="text-end">Ventas</th>
              <th class="text-end">Producción</th>
              <th class="text-end">Pedidos</th>
            </tr>
          </thead>
          <tbody>
            @for (r of monthlyComparative; track r.month) {
              <tr>
                <td class="fw-semibold">{{ r.month }}</td>
                <td class="text-end">{{ r.sales }}</td>
                <td class="text-end">{{ r.production }}</td>
                <td class="text-end">{{ r.orders }}</td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <div class="mt-3 d-flex flex-wrap gap-2">
        <button class="btn btn-outline-primary btn-sm">Descargar comparativo</button>
        <button class="btn btn-outline-secondary btn-sm">Ver gráfico</button>
      </div>
    }

  </div>

</div>
